name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    uses: "./.github/workflows/build-components.yaml"
    secrets: inherit

  package-and-release:
    name: "Release"
    runs-on: "ubuntu-latest"
    needs: [ "build" ]
    steps:
      - uses: "actions/checkout@v6"
        with:
          fetch-depth: "0"

      # Скачиваем ВСЕ артефакты
      - name: "Download all binaries and installer artifacts"
        uses: "actions/download-artifact@v7"
        with:
          path: "artifacts"

      - name: "Set version from tag"
        run: "echo \"VERSION=${GITHUB_REF#refs/tags/v}\" >> $GITHUB_ENV"

      - name: "Debug: List all artifacts structure"
        run: |
          echo "Artifacts structure:"
          find artifacts -type f -name "*" | sort

      - name: "Prepare files for packaging"
        run: |
          mkdir -p release_files/server
          mkdir -p release_files/client-linux-amd64
          mkdir -p release_files/client-linux-arm64
          mkdir -p release_files/client-windows
          mkdir -p release_files/client-macos
          
          # SERVER
          cp artifacts/anet-server-full/anet-server release_files/server/
          cp artifacts/anet-server-full/anet-auth release_files/server/
          cp contrib/config/server.toml release_files/server/
          if [ -f "contrib/config/.env.example.auth" ]; then
             cp contrib/config/.env.example.auth release_files/server/
          fi
          mkdir -p release_files/server/keygen
          cp artifacts/anet-server-full/anet-keygen release_files/server/keygen/
          cp artifacts/anet-server-full/anet-keygen.exe release_files/server/keygen/
          
          # LINUX CLIENT AMD64
          cp artifacts/anet-client-linux-amd64/anet-client release_files/client-linux-amd64/
          cp contrib/config/client.toml release_files/client-linux-amd64/
          
          # LINUX CLIENT ARM64
          cp artifacts/anet-client-linux-arm64/anet-client release_files/client-linux-arm64/
          cp contrib/config/client.toml release_files/client-linux-arm64/
          
          # WINDOWS CLIENT
          CLIENT_WIN_DIR="release_files/client-windows"
          if [ -f "artifacts/anet-client-windows-cli/anet-client.exe" ]; then
            cp artifacts/anet-client-windows-cli/anet-client.exe ${CLIENT_WIN_DIR}/
          fi
          if [ -f "artifacts/anet-client-windows-gui/anet-gui.exe" ]; then
            cp artifacts/anet-client-windows-gui/anet-gui.exe ${CLIENT_WIN_DIR}/
          fi
          cp contrib/config/client.toml ${CLIENT_WIN_DIR}/
          
          # MACOS CLIENT
          CLIENT_MAC_DIR="release_files/client-macos"
          if [ -f "artifacts/anet-client-macos-app/ANet_VPN_macOS.app.zip" ]; then
            unzip "artifacts/anet-client-macos-app/ANet_VPN_macOS.app.zip" -d ${CLIENT_MAC_DIR}/
          fi
          if [ -f "artifacts/anet-client-macos-cli/anet-client" ]; then
            cp artifacts/anet-client-macos-cli/anet-client ${CLIENT_MAC_DIR}/
            chmod +x ${CLIENT_MAC_DIR}/anet-client
          fi
          cp contrib/config/client.toml ${CLIENT_MAC_DIR}/
          
          # WINTUN DOWNLOAD
          cd ${CLIENT_WIN_DIR}
          curl -sLO "https://www.wintun.net/builds/wintun-0.14.1.zip"
          unzip "wintun-0.14.1.zip"
          cp "wintun/bin/amd64/wintun.dll" .
          rm -rf "wintun" "wintun-0.14.1.zip"
          cd ../..
          
          # ANDROID APK
          APK_SRC=$(find artifacts/anet-android-apk -name '*.apk' | head -n 1)
          if [ -n "$APK_SRC" ]; then
              cp "$APK_SRC" "anet-android-${VERSION}.apk"
          fi
      - name: "Create zip archives"
        run: |
          cd release_files
          
          # Server
          zip -r "server_${VERSION}.zip" server/
          
          # Linux Clients (Теперь две разные архитектуры)
          zip -r "client-linux-amd64_${VERSION}.zip" client-linux-amd64/
          zip -r "client-linux-arm64_${VERSION}.zip" client-linux-arm64/
          
          # Windows Client
          zip -r "client-windows_${VERSION}.zip" client-windows/
          
          # MacOS zip (сохраняет симлинки внутри .app, если они есть)
          zip -r -y "client-macos_${VERSION}.zip" client-macos/
          
          cd ..
          
          # Windows Installer (Копируем в корень для загрузки)
          if [ -d "artifacts/anet-client-setup-windows" ]; then
            INSTALLER_EXE=$(find artifacts/anet-client-setup-windows -name '*.exe' | head -n 1)
            if [ -n "$INSTALLER_EXE" ]; then 
              cp "$INSTALLER_EXE" "ANET_VPN_Client_Setup_${VERSION}_x64.exe"
            else
              echo "Warning: Windows installer EXE not found"
            fi
          fi
      - name: "Create Release"
        uses: "softprops/action-gh-release@v2"
        with:
            tag_name: ${{ github.ref }}
            name: Release ${{ github.ref }}
            files: |
              release_files/server_${{ env.VERSION }}.zip
              release_files/client-linux-amd64_${{ env.VERSION }}.zip
              release_files/client-linux-arm64_${{ env.VERSION }}.zip
              release_files/client-windows_${{ env.VERSION }}.zip
              release_files/client-macos_${{ env.VERSION }}.zip
              ANET_VPN_Client_Setup_${{ env.VERSION }}_x64.exe
              anet-android-${{ env.VERSION }}.apk
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
