name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    uses: "./.github/workflows/build-components.yaml"

  package-and-release:
    name: "Release"
    runs-on: "ubuntu-latest"
    needs: ["build"]
    steps:
      - uses: "actions/checkout@v4"
        with:
          fetch-depth: "0"

      # Скачиваем ВСЕ артефакты
      - name: "Download all binaries and installer artifacts"
        uses: "actions/download-artifact@v4"
        with:
          path: "artifacts"

      - name: "Set version from tag"
        run: "echo \"VERSION=${GITHUB_REF#refs/tags/v}\" >> $GITHUB_ENV"

      - name: "Prepare files for packaging"
        run: |
          mkdir -p release_files/server release_files/client-linux release_files/client-windows
          
          # --- LINUX SERVER & CLIENT ---
          cp artifacts/anet-server/anet-server release_files/server/
          cp artifacts/anet-client-linux/anet-client release_files/client-linux/
          
          # --- WINDOWS CLIENT ---
          CLIENT_WIN_DIR="release_files/client-windows"
          cp artifacts/anet-client-windows/anet-client.exe ${CLIENT_WIN_DIR}/

          # --- CONFIGS ---
          cp contrib/config/server.toml release_files/server/
          cp contrib/config/client.toml release_files/client-linux/
          cp contrib/config/client.toml ${CLIENT_WIN_DIR}/

          # --- WINTUN (Windows) ---
          cd ${CLIENT_WIN_DIR}
          WINTUN_VERSION="0.14.1"
          WINTUN_URL="https://www.wintun.net/builds/wintun-${WINTUN_VERSION}.zip"
          curl -sLO "$WINTUN_URL"
          unzip "wintun-${WINTUN_VERSION}.zip"
          cp "wintun/bin/amd64/wintun.dll" .
          rm -rf "wintun" "wintun-${WINTUN_VERSION}.zip"
          cd ../..
          
          # --- ANDROID APK ---
          # Ищем apk в папке артефактов (имя папки 'anet-android-apk' задается в build-components)
          APK_SRC=$(find artifacts/anet-android-apk -name '*.apk' | head -n 1)
          if [ -z "$APK_SRC" ]; then
              echo "Warning: Android APK not found in artifacts!"
          else
              # Копируем и переименовываем с версией
              cp "$APK_SRC" "anet-android-${VERSION}.apk"
          fi

      - name: "Create zip archives"
        run: |
          cd release_files
          zip -r "server_${VERSION}.zip" server/
          zip -r "client-linux_${VERSION}.zip" client-linux/
          zip -r "client-windows_${VERSION}.zip" client-windows/
          
          # Windows Installer
          INSTALLER_EXE=$(find ../artifacts/anet-client-setup-windows -name '*.exe')
          if [ -z "$INSTALLER_EXE" ]; then 
              echo "Error: Windows installer EXE not found"
              exit 1
          fi
          cp $INSTALLER_EXE ../ANET_VPN_Client_Setup_${VERSION}_x64.exe
          cd ..

      - name: "Create Release"
        uses: "softprops/action-gh-release@v1"
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ github.ref }}
          files: |
            release_files/server_${{ env.VERSION }}.zip
            release_files/client-linux_${{ env.VERSION }}.zip
            release_files/client-windows_${{ env.VERSION }}.zip
            ANET_VPN_Client_Setup_${{ env.VERSION }}_x64.exe
            anet-android-${{ env.VERSION }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}