; Script generated by GitHub Actions

#define MyAppName "ANet VPN Client"
#define MyAppPublisher "ANet Project"
#define MyAppCliExeName "anet-client.exe"
#define MyAppGuiExeName "anet-gui.exe"

#ifndef MyAppVersion
  #define MyAppVersion "dev-beta" ; Fallback version if not defined by CI
#endif

; --- Setup Section ---
[Setup]
AppId={{836D1693-5B60-4635-B6E6-A9F9C89638F8}
AppName={#MyAppName}
AppVersion={#MyAppVersion}
AppPublisher={#MyAppPublisher}
; УСТАНОВКА БИНАРНИКОВ: Program Files (для системной чистоты)
DefaultDirName={autopf}\ANET VPN Client
DefaultGroupName={#MyAppName}
AllowNoIcons=no
; Требование: Windows 10 (Build 10240) или выше.
MinVersion=10.0.10240
; ПРАВА АДМИНИСТРАТОРА (Необходимы для Program Files и HKLM)
PrivilegesRequired=admin
ArchitecturesAllowed=x64
ArchitecturesInstallIn64BitMode=x64
OutputBaseFilename=ANet_VPN_Client_Setup_{#MyAppVersion}_x64
Compression=lzma2/ultra64
SolidCompression=yes
WizardStyle=modern
UninstallDisplayIcon={app}\anet.ico

[Tasks]
; Задача на создание иконки (для использования в секции [Icons])
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; Flags: checkedonce

; --- File Section ---
[Files]
; 1. БИНАРНИКИ: Устанавливаются в {app} (Program Files)
Source: "anet-client.exe"; DestDir: "{app}"; Flags: ignoreversion
Source: "anet-gui.exe"; DestDir: "{app}"; Flags: ignoreversion
Source: "wintun.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "anet.ico"; DestDir: "{app}"; Flags: ignoreversion

; 2. КОНФИГ: Устанавливается в {userappdata}\anet\. Флаг onlyifdoesntexist гарантирует, что пользовательский конфиг не будет затерт при обновлении.
; Note: Мы используем Flags: uninsneveruninstall, чтобы конфигурация осталась после деинсталляции.
Source: "client.toml"; DestDir: "{userappdata}\anet"; DestName: "default.toml"

; CLI
; --- Icons/Shortcuts Section ---
[Icons]
; 1. Ярлык запуска клиента (Меню Пуск). Клиент будет использовать UAC благодаря Реестру.
Name: "{autoprograms}\{#MyAppCliExeName}"; Filename: "{app}\{#MyAppCliExeName}"; Parameters: "-c ""{userappdata}\anet\default.toml"""; IconFilename: "{app}\anet.ico"

; 1. Ярлык запуска клиента (Рабочий стол).
Name: "{autodesktop}\{#MyAppCliExeName}"; Filename: "{app}\{#MyAppCliExeName}"; Parameters: "-c ""{userappdata}\anet\default.toml"""; IconFilename: "{app}\anet.ico"; Tasks: desktopicon

;-------------- GUI
; --- Icons/Shortcuts Section ---
[Icons]
; 1. Ярлык запуска клиента (Меню Пуск). Клиент будет использовать UAC благодаря Реестру.
Name: "{autoprograms}\{#MyAppGuiExeName}"; Filename: "{app}\{#MyAppGuiExeName}"; IconFilename: "{app}\anet.ico"

; 1. Ярлык запуска клиента (Рабочий стол).
Name: "{autodesktop}\{#MyAppGuiExeName}"; Filename: "{app}\{#MyAppGuiExeName}"; IconFilename: "{app}\anet.ico"; Tasks: desktopicon

; 2. Ярлык для быстрого редактирования конфига (Рабочий стол). Запускает Блокнот.
Name: "{autodesktop}\Edit ANET Config"; Filename: "notepad.exe"; Parameters: """{userappdata}\anet\default.toml"""; IconFilename: "{sys}\notepad.exe"; Tasks: desktopicon

; --- Registry Section ---
[Registry]
; Установка флага RUNASADMIN в реестре для принудительного запуска от имени администратора.
; Флаг Flags: uninsdeletevalue гарантирует чистку при удалении.
Root: HKLM; Subkey: "SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers"; \
    ValueType: string; ValueName: "{app}\{#MyAppCliExeName}"; ValueData: "~ RUNASADMIN"; \
    Flags: uninsdeletevalue

Root: HKLM; Subkey: "SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers"; \
    ValueType: string; ValueName: "{app}\{#MyAppGuiExeName}"; ValueData: "~ RUNASADMIN"; \
    Flags: uninsdeletevalue